\chapter{Medium-level intermediate representation}
\label{chap-mir}

The compiler translates an abstract syntax tree into a \emph{graph} of
\emph{instructions} in a language named \emph{MIR}.  This graph is a
variation on a \emph{control flow graph}.  As such, it has a unique
instruction called the \emph{initial instruction} which is the
instruction where the execution of the MIR program starts. 

In general an instruction can have zero, one, or more
\emph{successors}, and zero, one, or more \emph{predecessors}.

An instruction can also have zero, one, or several \emph{inputs} and
zero, one, or more \emph{outputs}.  An input may be an \emph{constant}
value or a \emph{lexical variable}.%
\footnote{The only exception to this rule is that an
  \texttt{enclose-instruction} has an \texttt{enter-instruction} as
  its input.}  An output may only be a lexical variable.

The execution of a a MIR instruction consists of generating the
outputs as a function of the inputs, and also of choosing a successor
based on the inputs.

The execution of a MIR program consists of starting execution at the
\emph{initial instruction} and executing a sequence of instructions
where an instruction in the sequence is the successor chosen during
the execution of the preceding instruction in the sequence.

A MIR program is said to be \emph{well formed} if and only if the
restrictions on each of the instructions are respected, as defined in
\refSec{sec-mir-instructions}.

It is possible for a well-formed MIR program to contain instructions
that are not \emph{reachable} in that there is no execution path from
the initial instruction to such an instruction.  This situation can
arise as a result of certain optimizations that determine that a
particular successor arc of some instruction can never be chosen, and
so removes that arc.  In certain cases, the instruction at the head of
that arc may then not be reachable from the initial instruction.  

\section{Definition of MIR instructions}
\label{sec-mir-instructions}

\subsection{Instruction \texttt{NOP}}
\label{mir-instruction-NOP}

This instruction has a single successor.  It has no inputs and no
outputs.

Executing this instruction has no effect. 

\subsection{Instruction \texttt{assignment}}
\label{mir-instruction-assignment}

This instruction has a single successor.  It has a single input and a
single output. 

The execution of this instruction results in the input being copied to
the output without any modification. 

\subsection{Instruction \texttt{test}}
\label{mir-instruction-test}

This instruction has two successors.  It has a single input. 

The first successor is chosen if the input is \emph{true} and the
second input is chosen if the input is \emph{false}.%
\fixme{Check that this statement is true.}

\subsection{Instruction \texttt{funcall}}
\label{mir-instruction-funcall}

This instruction has a single successor.  It can have any number of
inputs, and it has no outputs.  The inputs correspond to the function
to call and to the arguments of that function.

\subsection{Instruction \texttt{get-values}}
\label{mir-instruction-get-values}

This instruction has a single successor.  It has no inputs and it can
have any number of outputs.

The effect of this instruction is to assign the values of a preceding
function call to a set of lexical variables. 

\subsection{Instruction \texttt{return}}
\label{mir-instruction-return}

This instruction has no successors.  It can have any number of
inputs, and it has no outputs.  The inputs correspond to the values
transmitted to the caller

It terminates execution of the current function and returns to the
caller. 

\subsection{Instruction \texttt{enclose}}
\label{mir-instruction-enclose}

This instruction has a single successor.  It has a single output. 
It does have an input, but it is a special one because it is not a
value, but instead the root of an instruction graph.  

The instruction takes the instruction graph and creates a
\emph{closure}.  The closure contains the current lexical runtime
environment and the code resulting from the input instruction graph.

%%  LocalWords:  optimizations
