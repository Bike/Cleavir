\chapter{Medium-level intermediate representation}
\label{chap-mir}

The compiler translates an abstract syntax tree into a \emph{graph} of
\emph{instructions} in a language named \emph{MIR}.  This graph is a
variation on a \emph{control flow graph}.  As such, it has a unique
instruction called the \emph{initial instruction} which is the
instruction where the execution of the MIR program starts. 

In general an instruction can have zero, one, or more
\emph{successors}, and zero, one, or more \emph{predecessors}.

An instruction can also have zero, one, or several \emph{inputs} and
zero, one, or more \emph{outputs}.  An input may be an \emph{constant}
value or a \emph{lexical variable}.%
\footnote{The only exception to this rule is that an
  \texttt{enclose-instruction} has an \texttt{enter-instruction} as
  its input.}  An output may only be a lexical variable.

The execution of a a MIR instruction consists of generating the
outputs as a function of the inputs, and also of choosing a successor
based on the inputs.

The execution of a MIR program consists of starting execution at the
\emph{initial instruction} and executing a sequence of instructions
where an instruction in the sequence is the successor chosen during
the execution of the preceding instruction in the sequence.

A MIR program is said to be \emph{well formed} if and only if the
restrictions on each of the instructions are respected, as defined in
\refSec{sec-mir-instructions}.

It is possible for a well-formed MIR program to contain instructions
that are not \emph{reachable} in that there is no execution path from
the initial instruction to such an instruction.  This situation can
arise as a result of certain optimizations that determine that a
particular successor arc of some instruction can never be chosen, and
so removes that arc.  In certain cases, the instruction at the head of
that arc may then not be reachable from the initial instruction.  

Because of the existence of \texttt{enclose-instruction}s, the concept
of reachability is actually a bit more complicated than what was
hinted in the previous paragraph.  More formally, an instruction is
reachable if and only if:

\begin{itemize}
\item it is an \texttt{enter-instruction}, or
\item it has a reachable predecessor.
\end{itemize}

By stating that every \texttt{enter-instruction} is reachable a
priori, we implicitly assume that the closure generated as the output
of every \texttt{enclose-instruction} is actually \emph{used}.
Whether this is the case or not is of course \emph{undecidable}, but
the translation from an abstract syntax tree to MIR eliminates some of
the cases where the closure may not be used, in that it does not
generate output for anonymous functions that are evaluated in a
context where the resulting closure is obviously not needed.

A MIR program is said to be \emph{reduced} if and only if it is
\emph{well formed} and every instruction is \emph{reachable}. 

\section{Definition of MIR instructions}
\label{sec-mir-instructions}

\subsection{Instruction \texttt{enter-instruction}}
\label{mir-instruction-enter}

\begin{tabular}{|l|l|}
\hline
Number of inputs & 0\\
\hline
Number of outputs & any\\
\hline
Number of predecessors & 0\\
\hline
Number of successors & 1\\
\hline
\end{tabular}

An instruction of this type is either the initial instruction of a MIR
program, or an input to an \texttt{enclose-instruction}.  The outputs
of this instruction corresponds to the parameters the function as
follows: 

\begin{itemize}
\item There is an output for every required parameter.
\item For each optional parameter and for each keyword parameter,
  there are two outputs, one for the parameter itself and one for the
  \texttt{supplied-p} parameter.
\end{itemize}

The execution of this instruction involves parsing the arguments given
to the function, and setting the outputs accordingly.  

This instruction has an accessor named \texttt{lambda-list}.  The
lambda list of the \texttt{enter-instruction} resembles an ordinary
lambda list in that it has a number of required parameters, possibly a
\texttt{\&rest} parameter and some \texttt{\&optional} and
\texttt{\&key} parameters.  It differs from an ordinary lambda list in
the following way:

\begin{itemize}
\item Each required parameter is a \texttt{lexical-location} which is
  also one of the outputs of the instruction.
\item If the \texttt{\&rest} lambda list keyword is present, it is
  followed by a \texttt{lexical-location} which is also one of the
  outputs of the instruction.
\item If the \texttt{\&optional} lambda list keyword is present, it is
  followed by any number of two-element lists.  Each element of each
  such lists is a \texttt{lexical-location} which is also one of the
  outputs of the instruction.  The first element represents the
  argument if it was given and the second element represents a
  \texttt{supplied-p} argument containing either \texttt{nil} or
  \texttt{t}.
\item If the \texttt{\&key} lambda list keyword is present, it is
  followed by any number of three-element lists.  The first element of
  each such list is a \emph{symbol} (typically a symbol in the
  \texttt{keyword} package) used to recognize whether the
  corresponding argument has been given.  The second element and the
  third element of each list is a \texttt{lexical-location} which is
  also one of the outputs of the instruction.  The second element
  represents the argument if it was given and the third element
  represents a \texttt{supplied-p} argument containing either
  \texttt{nil} or \texttt{t}.
\end{itemize}

Notice that the outputs are lexical locations independently of whether
the parameters to the function are special variables.  The MIR
instructions following the \texttt{enter-instruction} are responsible
for binding special variables and assigning default values to
unsupplied \texttt{\&optional} and \texttt{\&key} parameters.

\refFig{fig-enter-instruction} shows the Graphviz illustration of the
\texttt{enter-instruction}

\begin{figure}
\begin{center}
\inputfig{fig-enter-instruction.pdf_t}
\end{center}
\caption{\label{fig-enter-instruction}
\texttt{enter-instruction}.}
\end{figure}

\subsection{Instruction \texttt{nop-instruction}}
\label{mir-instruction-nop}

\begin{tabular}{|l|l|}
\hline
Number of inputs & 0\\
\hline
Number of outputs & 0\\
\hline
Number of predecessors & any\\
\hline
Number of successors & 1\\
\hline
\end{tabular}

Executing this instruction has no effect. 

\refFig{fig-nop-instruction} shows the Graphviz illustration of the
\texttt{nop-instruction}

\begin{figure}
\begin{center}
\inputfig{fig-nop-instruction.pdf_t}
\end{center}
\caption{\label{fig-nop-instruction}
\texttt{nop-instruction}.}
\end{figure}

\subsection{Instruction \texttt{assignment-instruction}}
\label{mir-instruction-assignment}

\begin{tabular}{|l|l|}
\hline
Number of inputs & 1\\
\hline
Number of outputs & 1\\
\hline
Number of predecessors & any\\
\hline
Number of successors & 1\\
\hline
\end{tabular}

The execution of this instruction results in the input being copied to
the output without any modification. 

\refFig{fig-assignment-instruction} shows the Graphviz illustration of the
\texttt{assignment-instruction}

\begin{figure}
\begin{center}
\inputfig{fig-assignment-instruction.pdf_t}
\end{center}
\caption{\label{fig-assignment-instruction}
\texttt{assignment-instruction}.}
\end{figure}

\subsection{Instruction \texttt{funcall-instruction}}
\label{mir-instruction-funcall}

\begin{tabular}{|l|l|}
\hline
Number of inputs & any\\
\hline
Number of outputs & any\\
\hline
Number of predecessors & any\\
\hline
Number of successors & 1\\
\hline
\end{tabular}

The first input of this instruction corresponds to the function being
called.  It can be either a lexical location or a global-input.  
The remaining inputs correspond to the arguments to be passed to the
callee. 

The outputs of this instruction correspond to the values that the
caller requests from the callee.  The number of outputs can therefore
be different from the actual number of values produced by the caller.

\refFig{fig-funcall-instruction} shows the Graphviz illustration of the
\texttt{funcall-instruction}

\begin{figure}
\begin{center}
\inputfig{fig-funcall-instruction.pdf_t}
\end{center}
\caption{\label{fig-funcall-instruction}
\texttt{funcall-instruction}.}
\end{figure}

\subsection{Instruction \texttt{tailcall-instruction}}
\label{mir-instruction-tailcall}

\begin{tabular}{|l|l|}
\hline
Number of inputs & any\\
\hline
Number of outputs & 0\\
\hline
Number of predecessors & any\\
\hline
Number of successors & 0\\
\hline
\end{tabular}

The first input of this instruction corresponds to the function being
called.  It can be either a lexical location or a global-input.  
The remaining inputs correspond to the arguments to be passed to the
callee. 

\refFig{fig-tailcall-instruction} shows the Graphviz illustration of the
\texttt{tailcall-instruction}

\begin{figure}
\begin{center}
\inputfig{fig-tailcall-instruction.pdf_t}
\end{center}
\caption{\label{fig-tailcall-instruction}
\texttt{tailcall-instruction}.}
\end{figure}

\subsection{Instruction \texttt{return-instruction}}
\label{mir-instruction-return}

\begin{tabular}{|l|l|}
\hline
Number of inputs & any\\
\hline
Number of outputs & 0\\
\hline
Number of predecessors & any\\
\hline
Number of successors & 0\\
\hline
\end{tabular}

The inputs of this instruction correspond to the values transmitted to
the caller

It terminates execution of the current function and returns to the
caller. 

\refFig{fig-return-instruction} shows the Graphviz illustration of the
\texttt{return-instruction}

\begin{figure}
\begin{center}
\inputfig{fig-return-instruction.pdf_t}
\end{center}
\caption{\label{fig-return-instruction}
\texttt{return-instruction}.}
\end{figure}

\subsection{Instruction \texttt{enclose-instruction}}
\label{mir-instruction-enclose}

\begin{tabular}{|l|l|}
\hline
Number of inputs & 1\\
\hline
Number of outputs & 1\\
\hline
Number of predecessors & any\\
\hline
Number of successors & 1\\
\hline
\end{tabular}

The input of this instruction is different from those of other
instructions because it is another instruction, namely an
\texttt{enter-instruction}.

The instruction takes the instruction graph of the input and creates a
\emph{closure}.  The closure contains the current lexical runtime
environment and the code resulting from the input instruction graph.

\refFig{fig-enclose-instruction} shows the Graphviz illustration of the
\texttt{enclose-instruction}

\begin{figure}
\begin{center}
\inputfig{fig-enclose-instruction.pdf_t}
\end{center}
\caption{\label{fig-enclose-instruction}
\texttt{enclose-instruction}.}
\end{figure}

\subsection{Instruction \texttt{test-instruction}}
\label{mir-instruction-test}

\begin{tabular}{|l|l|}
\hline
Number of inputs & 1\\
\hline
Number of outputs & 0\\
\hline
Number of predecessors & any\\
\hline
Number of successors & 2\\
\hline
\end{tabular}

The input of this instruction is a generalized Boolean.  The first
successor is chosen if the value of the input is \emph{true} and the
second successor is chosen of the value of the input is \emph{false}.

\refFig{fig-test-instruction} shows the Graphviz illustration of the
\texttt{test-instruction}

\begin{figure}
\begin{center}
\inputfig{fig-test-instruction.pdf_t}
\end{center}
\caption{\label{fig-test-instruction}
\texttt{test-instruction}.}
\end{figure}

\subsection{Instruction \texttt{car-instruction}}
\label{mir-instruction-car}

\begin{tabular}{|l|l|}
\hline
Number of inputs & 1\\
\hline
Number of outputs & 1\\
\hline
Number of predecessors & any\\
\hline
Number of successors & 1\\
\hline
\end{tabular}

The input to this instruction must be a \texttt{cons} cell.  If the
MIR program is \emph{safe}, then control must reach this instruction
only if this restriction is verified.  The output is the contents of
the \texttt{car} of the \texttt{cons} cell.

\refFig{fig-car-instruction} shows the Graphviz illustration of the
\texttt{car-instruction}

\begin{figure}
\begin{center}
\inputfig{fig-car-instruction.pdf_t}
\end{center}
\caption{\label{fig-car-instruction}
\texttt{car-instruction}.}
\end{figure}

\subsection{Instruction \texttt{cdr-instruction}}
\label{mir-instruction-cdr}

\begin{tabular}{|l|l|}
\hline
Number of inputs & 1\\
\hline
Number of outputs & 1\\
\hline
Number of predecessors & any\\
\hline
Number of successors & 1\\
\hline
\end{tabular}

The input to this instruction must be a \texttt{cons} cell.  If the
MIR program is \emph{safe}, then control must reach this instruction
only if this restriction is verified.  The output is the contents of
the \texttt{cdr} of the \texttt{cons} cell.

\refFig{fig-cdr-instruction} shows the Graphviz illustration of the
\texttt{cdr-instruction}

\begin{figure}
\begin{center}
\inputfig{fig-cdr-instruction.pdf_t}
\end{center}
\caption{\label{fig-cdr-instruction}
\texttt{cdr-instruction}.}
\end{figure}

\subsection{Instruction \texttt{rplaca-instruction}}
\label{mir-instruction-rplaca}

\begin{tabular}{|l|l|}
\hline
Number of inputs & 2\\
\hline
Number of outputs & 0\\
\hline
Number of predecessors & any\\
\hline
Number of successors & 1\\
\hline
\end{tabular}

The first input to this instruction must be a \texttt{cons} cell.  If
the MIR program is \emph{safe}, then control must reach this
instruction only if this restriction is verified.  The second input
can be any object.  The effect of the instruction is to replace the
contents of the \texttt{car} of the \texttt{cons} cell by the second
input.

\refFig{fig-rplaca-instruction} shows the Graphviz illustration of the
\texttt{rplaca-instruction}

\begin{figure}
\begin{center}
\inputfig{fig-rplaca-instruction.pdf_t}
\end{center}
\caption{\label{fig-rplaca-instruction}
\texttt{rplaca-instruction}.}
\end{figure}

\subsection{Instruction \texttt{rplacd-instruction}}
\label{mir-instruction-rplacd}

\begin{tabular}{|l|l|}
\hline
Number of inputs & 2\\
\hline
Number of outputs & 0\\
\hline
Number of predecessors & any\\
\hline
Number of successors & 1\\
\hline
\end{tabular}

The first input to this instruction must be a \texttt{cons} cell.  If
the MIR program is \emph{safe}, then control must reach this
instruction only if this restriction is verified.  The second input
can be any object.  The effect of the instruction is to replace the
contents of the \texttt{cdr} of the \texttt{cons} cell by the second
input.

\refFig{fig-rplacd-instruction} shows the Graphviz illustration of the
\texttt{rplacd-instruction}

\begin{figure}
\begin{center}
\inputfig{fig-rplacd-instruction.pdf_t}
\end{center}
\caption{\label{fig-rplacd-instruction}
\texttt{rplacd-instruction}.}
\end{figure}

%%  LocalWords:  optimizations reachability unsupplied callee runtime
