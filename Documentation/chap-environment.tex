\chapter{Environment}
\label{chap-environment}

\section{Introduction}

Compiling a \cl{} program is done in constant interaction with an
\emph{environment}.  The \hs{} stipulates%
\footnote{See Section 3.2.1 of the \hs{}.}
that there are four different environments that are relevant to
compilation:

\begin{itemize}
\item The \emph{startup environment}.  This environment is the global
  environment of the \cl{} system when the compiler was invoked.
\item The \emph{compilation environment}.  This environment is the
  local environment in which forms are compiled.  It is also the
  environment that is passed to macro expanders.
\item The \emph{evaluation environment}.  According to the \hs{}, this
  environment is ``a run-time environment in which macro expanders and
  code specified by \texttt{eval-when} to be evaluated are
  evaluated''. 
\item The \emph{run-time environment}.  This environment is used when
  the resulting compiled program is executed.
\end{itemize}

The \hs{} does not specify how environments are represented, and there
is no specified protocol for manipulating environments.  As a result,
each implementation has its own representation and its own protocols. 

It might seem that \sysname{} could represent the \emph{local part} of
the environment (i.e., the part of the environment that is temporarily
introduced when nested forms are compiled) in whatever way it pleases,
but this is not the case.  The reason is that the full environment
must be passed as an argument to macro expanders that are defined in
the startup environment, and those macro expanders are implementation
specific.  It is also not possible for \sysname{} to define its own
version of \texttt{macroexpand}, because a globally defined
implementation-specific macro expander may call the
implementation-specific version of \texttt{macroexpand} which would
fail if given an environment other than the one defined by the
implementation. 

On the other hand, an incomplete implementation for which no
representation of the local part of the environment has been
determined might want to use some such representation that is known to
work.  For that reason, \sysname{} proposes a \emph{default
  representation} of that local part of the environment.  The default
version can also be used by more complete implementations, provided
that the implementation-specific version of \texttt{macroexpand} is
not called on an environment using this default representation. 

\section{Querying the environment}

In this section, we describe classes and functions that are used by
the compiler to query the environment concerning information about
program elements that the compiler needs in order to determine how to
process those program elements. 

When the compiler calls a generic query function, it passes the
environment as the first argument.  Client code must supply methods
on these functions, specialized to its particular representation of
environments. 

These methods should return instances of the classes described in this
section.  Any such instance contains all available information about
some program element in that particular environment.  This information
must typically be assembled from different parts of the environment.
For that reason, client code typically creates a new instance whenever
a query function is called, rather than attempting to store such
instances in the environment. 

Client code is free to define subclasses of the classes described
here, for instance in order to represent implementation-specific
information about the program elements.  Client code would then
typically also provide auxiliary methods or overriding primary methods
on the compilation functions that handle these classes.

\subsection{Variable information}

\Defgeneric {variable-info} {environment symbol}

This function is called by the compiler whenever a symbol in a
\emph{variable} position is to be compiled.  It returns an instance of
one of the classes described below.

\subsubsection{Lexical variable information}

\Defclass {lexical-variable-info}

This class represents information about lexical variables.  An
instance of this class is returned by a call to \texttt{variable-info}
when it turns out that the symbol passed as an argument refers to a
lexical variable.

\Definitarg {:name}

This initarg supplies the name of the lexical variable.  This initarg
must be supplied. 

\Definitarg {:location}

This initarg is used to supply some kind of implementation-defined 
\emph{location}.  The implementation can supply any object as the
location, because it is not interpreted by the compiler.  However, the
\emph{same} location must be supplied each time for a particular
special variable.  This initarg must be supplied. 

\Definitarg {:type}

This initarg is used to supply the \emph{type} of the lexical
variable.  The type can be any type specifier and it may contain
user-defined types.  If this initarg is omitted, it defaults to
\texttt{t}. 

\Defmethod {name} {(info {\tt lexical-variable-info})}

Given an instance of the class \texttt{lexical-variable-info}, this
method returns the name of the lexical variable as supplied by the
initarg \texttt{:name}.

\Defmethod {location} {(info {\tt lexical-variable-info})}

Given an instance of the class \texttt{lexical-variable-info}, this
method returns the location of the lexical variable as supplied by the
initarg \texttt{:location}.

\Defmethod {type} {(info {\tt lexical-variable-info})}

Given an instance of the class \texttt{lexical-variable-info}, this
method returns the \emph{type} of the variable as supplied by the
initarg \texttt{:type}.  If that initarg was not supplied, this method
returns \texttt{t}.

\subsubsection{Special variable information}

\Defclass {special-variable-info}

This class represents information about special variables.   An
instance of this class is returned by a call to \texttt{variable-info}
when it turns out that the symbol passed as an argument refers to a
special variable.


\Definitarg {:name}

This initarg supplies the name of the special variable.  This initarg
must be supplied. 

\Definitarg {:type}

This initarg is used to supply the \emph{type} of the special
variable.  The type can be any type specifier and it may contain
user-defined types.  If this initarg is omitted, it defaults to
\texttt{t}. 

\Defmethod {name} {(info {\tt special-variable-info})}

Given an instance of the class \texttt{special-variable-info}, this
method returns the name of the special variable as supplied by the
initarg \texttt{:name}.

\Defmethod {type} {(info {\tt special-variable-info})}

Given an instance of the class \texttt{special-variable-info}, this
method returns the \emph{type} of the variable as supplied by the
initarg \texttt{:type}.  If that initarg was not supplied, this method
returns \texttt{t}.

\subsubsection{Constant variable information}

\Defclass {constant-variable-info}

This class represents information about constant variables.   An
instance of this class is returned by a call to \texttt{variable-info}
when it turns out that the symbol passed as an argument refers to a
constant variable.

\Definitarg {:name}

This initarg supplies the name of the constant variable.  This initarg
must be supplied. 

\Definitarg {:value}

This initarg supplies the value of the constant variable.  This
initarg must be supplied.

\Defmethod {name} {(info {\tt constant-variable-info})}

Given an instance of the class \texttt{constant-variable-info}, this
method returns the name of the constant variable as supplied by the
initarg \texttt{:name}.

\Defmethod {value} {(info {\tt constant-variable-info})}

Given an instance of the class \texttt{constant-variable-info}, this
method returns the value of the constant variable as supplied by the
initarg \texttt{:value}.

\subsubsection{Symbol macro information}

\Defclass {symbol-macro-info}

This class represents information about symbol macros.  An
instance of this class is returned by a call to \texttt{variable-info}
when it turns out that the symbol passed as an argument refers to a
symbol macro.

\Definitarg {:name}

This initarg supplies the name of the symbol macro.  This initarg must
be supplied.

\Definitarg {:expansion}

This initarg supplies the expansion of the symbol macro.  This initarg
must be supplied.

\Definitarg {:type}

This initarg is used to supply the \emph{type} of the symbol macro.
The type can be any type specifier and it may contain user-defined
types.  If this initarg is omitted, it defaults to \texttt{t}.

\Defmethod {name} {(info {\tt symbol-macro-info})}

Given an instance of the class \texttt{symbol-macro-info}, this method
returns the name of the symbol macro as supplied by the initarg
\texttt{:name}.

\Defmethod {expansion} {(info {\tt symbol-macro-info})}

Given an instance of the class \texttt{symbol-macro-info}, this method
returns the expansion of the symbol macro as supplied by the initarg
\texttt{:expansion}.

\Defmethod {type} {(info {\tt symbol-macro-info})}

Given an instance of the class \texttt{symbol-macro-info}, this method
returns the \emph{type} of the symbol macro as supplied by the initarg
\texttt{:type}.  If that initarg was not supplied, this method returns
\texttt{t}.

\subsection{Function information}

\Defgeneric {function-info} {environment function-name}

This function is called by the compiler whenever a symbol in a
\emph{function} position is to be compiled or whenever a function name
is found in a context where it is known to refer to a function.  It
returns an instance of one of the classes described below.

\subsubsection{Local function information}

\Defclass {local-function-info}

This class represents information about local functions introduced by
\texttt{flet} or \texttt{labels}.  An instance of this class is
returned by a call to \texttt{function-info} when it turns out that
the function name passed as an argument refers to a local function. 

\Definitarg {:name}

This initarg supplies the name of the local function.  This initarg
must be supplied.

\Definitarg {:location}

This initarg is used to supply some kind of implementation-defined 
\emph{location}.  The implementation can supply any object as the
location, because it is not interpreted by the compiler.  However, the
\emph{same} location must be supplied each time for a particular
local function.  This initarg must be supplied. 

\Definitarg {:type}

This initarg is used to supply the \emph{type} of the local function.
The type can be any type specifier and it may contain user-defined
types.  If this initarg is omitted, it defaults to \texttt{t}.

\Definitarg {:inline}

This initarg is used to supply \emph{inline} information about the
local function.  The value of this initarg can be either
\texttt{:inline} meaning that the function is declared
\texttt{inline}, \texttt{:notinline} meaning that the function is
declared \texttt{notinline}, or \texttt{nil} meaning that no inline
declaration for this function is in scope.  If this initarg is not
supplied, it defaults to \texttt{nil}.

\Defmethod {name} {(info {\tt local-function-info})}

Given an instance of the class \texttt{local-function-info}, this
method returns the name of the local function as supplied by the
initarg \texttt{:name}.

\Defmethod {location} {(info {\tt local-function-info})}

Given an instance of the class \texttt{local-function-info}, this
method returns the location of the local function as supplied by the
initarg \texttt{:location}.

\Defmethod {type} {(info {\tt local-function-info})}

Given an instance of the class \texttt{local-function-info}, this
method returns the \emph{type} of the local function as supplied by the
initarg \texttt{:type}.  If that initarg was not supplied, this method
returns \texttt{t}.

\Defmethod {inline} {(info {\tt local-function-info})}

Given an instance of the class \texttt{local-function-info}, this
method returns the \emph{inline} information of the local function as
supplied by the initarg \texttt{:inline}.  If that initarg was not
supplied, this method returns \texttt{nil}.

\subsubsection{Global function information}

\Defclass {global-function-info}

This class represents information about global functions.  An instance
of this class is returned by a call to \texttt{function-info} when it
turns out that the function name passed as an argument refers to a
global function.

\Definitarg {:name}

This initarg supplies the name of the global function.  This initarg
must be supplied.

\Definitarg {:type}

This initarg is used to supply the \emph{type} of the global function.
The type can be any type specifier and it may contain user-defined
types.  If this initarg is omitted, it defaults to \texttt{t}.

\Definitarg {:inline}

This initarg is used to supply \emph{inline} information about the
global function.  The value of this initarg can be either
\texttt{:inline} meaning that the function is declared
\texttt{inline}, \texttt{:notinline} meaning that the function is
declared \texttt{notinline}, or \texttt{nil} meaning that no inline
declaration for this function is in scope.  If this initarg is not
supplied, it defaults to \texttt{nil}.

\Definitarg {:compiler-macro}

This initarg is used to supply a \emph{compiler macro function} when
compiler macro is associated with the global function.  If this
initarg is not given, it defaults to \texttt{nil}, meaning that no
compiler macro is associated with this function. 

\Defmethod {name} {(info {\tt global-function-info})}

Given an instance of the class \texttt{global-function-info}, this
method returns the name of the global function as supplied by the
initarg \texttt{:name}.

\Defmethod {type} {(info {\tt global-function-info})}

Given an instance of the class \texttt{global-function-info}, this
method returns the \emph{type} of the global function as supplied by the
initarg \texttt{:type}.  If that initarg was not supplied, this method
returns \texttt{t}.

\Defmethod {inline} {(info {\tt global-function-info})}

Given an instance of the class \texttt{global-function-info}, this
method returns the \emph{inline} information of the global function as
supplied by the initarg \texttt{:inline}.  If that initarg was not
supplied, this method returns \texttt{nil}.

\Defmethod compiler-macro {(info {\tt global-function-info})}

Given an instance of the class \texttt{global-function-info}, this
method returns the \emph{compiler macro function} information
associated with the global function, as supplied by the initarg
\texttt{:compiler-macro}.  If that initarg was not supplied, this
method returns \texttt{nil}.

\subsubsection{Local macro information}

\Defclass {local-macro-info}

This class represents information about local macros introduced by
\texttt{macrolet}.  An instance of this class is returned by a call to
\texttt{function-info} when it turns out that the function name passed
as an argument refers to a local macro.

\Definitarg {:name}

This initarg supplies the name of the local macro.  This initarg
must be supplied.

\Definitarg {:expander}

This initarg is used to supply the macro function used to expand macro
forms that use this macro.  This initarg must be supplied. 

\Defmethod {name} {(info {\tt local-macro-info})}

Given an instance of the class \texttt{local-macro-info}, this
method returns the name of the local macro as supplied by the
initarg \texttt{:name}.

\Defmethod {expander} {(info {\tt local-macro-info})}

Given an instance of the class \texttt{local-macro-info}, this
method returns the expander of the local macro as supplied by the
initarg \texttt{:expander}.

\subsection{Block information}

\Defgeneric {block-info} {environment symbol}

\Defclass {block-info}

\Definitarg {:name}

\Defmethod {name} {(info {\tt block-info})}

\subsection{Tag information}

\Defgeneric {tag-info} {environment symbol}

\Defclass {tag-info}

\Definitarg {:name}

\Defmethod {name} {(info {\tt tag-info})}

%%  LocalWords:  startup expanders expander subclasses
